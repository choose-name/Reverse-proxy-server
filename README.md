# Реверс-прокси сервер
Данный сервис написан и может использоваться двумя способами - через ansible-playbook скрипт установить на отдельную OS (в тестах использовался Vagrant для быстрого поднятия нескольких виртуальных серверов, файл с конфигурацией будет приложен) или через docker-compose.

## Ansible
Для реализации реверс-прокси посредством ansible-playbook нужно указать ip, метод аутентификации и желаемые параметры прокси сервера. Но сначала нужно устанавить на ПК, откуда будет запускаться скрипт, ansible. Для ПК на основе Debian
```
sudo apt-get install ansible
```
1. Так как ansible для настройки хостов использует стандартные средства удаленного подключения (в нашем случае ssh), сначала надо сконфигурировать файл hosts, в котором указывается имя машины (для правильной работы скрипта реверс-прокси сервер должен называться proxy), ip-адрес, порт для подключения (по умолчанию для ssh 22), имя пользователя и способ аутентификации (по паролю или ssh ключу). Так как с помощью ansible настраиваются одновременн несколько серверов, поэтому проще использовать ключ. Далее примерный вариант конфигурации файла hosts
```
[proxy_serv]
proxy ansible_host=192.168.1.102 ansible_port=22 ansible_user=vagrant ansible_ssh_private_key_file=./proxy_key
[web_clients]
web1 ansible_host=192.168.1.103 ansible_port=22 ansible_user=vagrant ansible_ssh_private_key_file=./web1_key
web2 ansible_host=192.168.1.104 ansible_port=22 ansible_user=vagrant ansible_ssh_private_key_file=./web2_key

```
2. Для настройки нужных url, ip адресов и имём пользователей используется файл group_vars/vars.yml. В нем все прокомментировано, поэтому сложностей недолжно возникнуть.
```

#На какие url будет срабатывать ревер-прокси сервер.
#Список можно расширять, главное придерживаться синтаксиса
proxy_server:
  - url: ns1.ru
    ip: 192.168.1.103 #IP адреса серверов, на которые нужно пересылать пользователя
  - url: ns2.ru
    ip: 192.168.1.104

#Создание пользователей для заданного url
#Этот список так же можно бесконечно увеличивать
#Но за один раз можно создать пользователей только для одного url
url: ns1.ru
create_user:
  - name: admin
    password: 1111
  - name: name2
    password: password2
```
3. Далее запускаем скрипт. На все сервера, указанные в файле hosts устанавливается nginx 1.22, а так же конфигурируется реверс-прокси сервер
```
ansible-playbook code-deploy.yml
```
4. Всё, все сервера настроены, реверс прокси работает. Если понадобится добавить дополнительные сервера или пользователей, то
```
ansible-playbook code-deploy.yml --tags proxy - добавить новый сервер, заранее изменив файл group_vars/vars.yml, чтобы не добавилось несколько одинаковых конфигураций
ansible-playbook code-deploy.yml --tags name - добавить новых пользователей
``` 

## Docker
1. Для установки докера
```
sudo apt install docker docker-compose 
```
2. Выставить нужные данные серверов можно в файле nginx.conf. В нем каждая нужна строчка прокоментирована. 
4. Далее запускаем docker-compose. Скрипт запускается в фоновом режиме
```
docker-compose up -d
```
5. Чтобы добавить новых пользователей нужно узнать id запущенного контейнера
```
docker ps -a
```
6. Далее создаем клиентов
```
docker-compose exec -it [id контейнера] htpasswd -cb [название файла] [username] [password] - тэк 'c' используется для создания файла, поэтому таким образом создаем только первого пользователя
docker-compose exec -it [id контейнера] htpasswd -b [название файла] [username] [password] - для добавления пользователей
```

## Vagrant
1. Для работы vagrant нужно установить [vagrant](https://www.vagrantup.com/downloads "vagrant")  и [virtualbox](https://www.virtualbox.org/wiki/Downloads).  На 6.5.2022 для установки vagrant нужен VPN.
2. Далее в командной строке переходим в директорию с файлом Vagrantfile и запускаем 4 виртуальные машины - два тестовых web - сервера, прокси сервер и машина клиента.
```
vagrant up
```
3. После успешного запуска всех машин можно посмотреть их статус работы, а так же их названия
```
vagrant global-status
```
4. Чтобы подключиться к нужной машине по ssh можно воспользоваться vagrant ssh
```
vagrant ssh [название машины]
```
5. Все данные, в том числе приватные ключи от ssh лежат в папке .vagrant/machines/[название машины]/
